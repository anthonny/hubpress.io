<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Un Sens&#x27;it, Meteor et mon Rolling Spider décolle</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Un Sens&#x27;it, Meteor et mon Rolling Spider décolle">
    <meta name="twitter:description" content="">

    <meta property="og:url" content="http://anthonnyquerouil.me">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Un Sens&#x27;it, Meteor et mon Rolling Spider décolle">
    <meta property="og:description" content="">
    <meta property="og:site_name" content="Anthonny Quérouil">

    <meta itemprop="name" content="Un Sens&#x27;it, Meteor et mon Rolling Spider décolle">
    <meta itemprop="description" content="">

    <link rel="stylesheet" href="//anthonnyquerouil.me/themes/indigo-theme/assets/main.8504bb27.css?v=1592555481261">
    <link rel="stylesheet" href="//anthonnyquerouil.me/themes/indigo-theme/assets/main.aa26f3f0.css?v=1592555481261">

    <link rel="canonical" href="http://anthonnyquerouil.me/2015/08/31/Un-Sensit-Meteor-et-mon-Rolling-Spider-decolle.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Anthonny Quérouil" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Un Sens&#x27;it, Meteor et mon Rolling Spider décolle" />
    <meta property="og:description" content="Comme vous l&amp;#8217;avez peut-être lu dans mon précédent billet http://anthonnyquerouil.fr/2015/08/24/Sensit-mon-petit-objet-connecte.html, j&amp;#8217;ai reçu récemment un Sens&amp;#8217;it. J&amp;#8217;ai aussi depuis peu un Rolling-spider que je m&amp;#8217;étais procuré dans le but de le controller avec un" />
    <meta property="og:url" content="http://anthonnyquerouil.me/2015/08/31/Un-Sensit-Meteor-et-mon-Rolling-Spider-decolle.html" />
    <meta property="article:published_time" content="2015-08-31T00:00:00.000Z" />
    <meta property="article:tag" content="Sensit" />
    <meta property="article:tag" content="IoT" />
    <meta property="article:tag" content="Sigfox" />
    <meta property="article:tag" content="Meteor" />
    <meta property="article:tag" content="Parrot" />
    <meta property="article:tag" content="Rolling Spider" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Un Sens&#x27;it, Meteor et mon Rolling Spider décolle" />
    <meta name="twitter:description" content="Comme vous l&amp;#8217;avez peut-être lu dans mon précédent billet http://anthonnyquerouil.fr/2015/08/24/Sensit-mon-petit-objet-connecte.html, j&amp;#8217;ai reçu récemment un Sens&amp;#8217;it. J&amp;#8217;ai aussi depuis peu un Rolling-spider que je m&amp;#8217;étais procuré dans le but de le controller avec un" />
    <meta name="twitter:url" content="http://anthonnyquerouil.me/2015/08/31/Un-Sensit-Meteor-et-mon-Rolling-Spider-decolle.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Anthonny Quérouil",
    "author": {
        "@type": "Person",
        "name": "Anthonny Quérouil",
        "image": "https://avatars1.githubusercontent.com/u/2006548?v=4",
        "url": "http://anthonnyquerouil.me/author/anthonny/",
        "sameAs": "http://www.anthonnyquerouil.fr"
    },
    "headline": "Un Sens&#x27;it, Meteor et mon Rolling Spider décolle",
    "url": "http://anthonnyquerouil.me/2015/08/31/Un-Sensit-Meteor-et-mon-Rolling-Spider-decolle.html",
    "datePublished": "2015-08-31T00:00:00.000Z",
    "keywords": "Sensit, IoT, Sigfox, Meteor, Parrot, Rolling Spider",
    "description": "Comme vous l&amp;#8217;avez peut-être lu dans mon précédent billet http://anthonnyquerouil.fr/2015/08/24/Sensit-mon-petit-objet-connecte.html, j&amp;#8217;ai reçu récemment un Sens&amp;#8217;it. J&amp;#8217;ai aussi depuis peu un Rolling-spider que je m&amp;#8217;étais procuré dans le but de le controller avec un"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Anthonny Quérouil" href="http://anthonnyquerouil.me/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>

<body class="post-template tag-Sensit tag-IoT tag-Sigfox tag-Meteor tag-Parrot tag-Rolling-Spider w-screen h-screen flex justify-center bg-white text-gray-900">
    <main class="w-full h-full max-w-800 flex flex-col">
        <header class="mt-2 flex items-center justify-between px-4 py-1 text-indigo-800">
            <section class="hidden md:block uppercase font-bold">
                <a class="text-indigo-800 hover:text-indigo-600" href="http://anthonnyquerouil.me">Anthonny Quérouil ::
                    Blog</a>
            </section>
            <section class="md:hidden uppercase font-bold">
                <a class="text-indigo-800 hover:text-indigo-600" href="http://anthonnyquerouil.me">AQ :: Blog</a>
            </section>
            <section>
                <ul class="flex items-center text-indigo-800">
                    <li class="ml-2 hover:text-indigo-600 fill-current">
                        <a href="https://twitter.com/anthonny_q">
                            <svg width="28" height="28" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M10 1.25C5.16797 1.25 1.25 5.16797 1.25 10C1.25 14.832 5.16797 18.75 10 18.75C14.832 18.75 18.75 14.832 18.75 10C18.75 5.16797 14.832 1.25 10 1.25ZM14.2051 7.8457C14.2109 7.9375 14.2109 8.0332 14.2109 8.12695C14.2109 10.9941 12.0273 14.2969 8.03711 14.2969C6.80664 14.2969 5.66602 13.9395 4.70508 13.3242C4.88086 13.3438 5.04883 13.3516 5.22852 13.3516C6.24414 13.3516 7.17773 13.0078 7.92188 12.4258C6.96875 12.4063 6.16797 11.7813 5.89453 10.9219C6.22852 10.9707 6.5293 10.9707 6.87305 10.8828C6.38228 10.7831 5.94116 10.5166 5.62464 10.1285C5.30812 9.7404 5.13572 9.2547 5.13672 8.75391V8.72656C5.42383 8.88867 5.76172 8.98828 6.11523 9.00195C5.81805 8.8039 5.57433 8.53557 5.40569 8.22076C5.23704 7.90596 5.14868 7.5544 5.14844 7.19727C5.14844 6.79297 5.25391 6.42383 5.44336 6.10352C5.98809 6.77409 6.66783 7.32254 7.43841 7.71321C8.20898 8.10389 9.05314 8.32803 9.91602 8.37109C9.60938 6.89648 10.7109 5.70312 12.0352 5.70312C12.6602 5.70312 13.2227 5.96484 13.6191 6.38672C14.1094 6.29492 14.5781 6.11133 14.9961 5.86523C14.834 6.36719 14.4941 6.79102 14.043 7.05859C14.4805 7.01172 14.9023 6.89063 15.293 6.7207C14.998 7.1543 14.6289 7.53906 14.2051 7.8457V7.8457Z" />
                            </svg>
                        </a>
                    </li>
                    <li class="ml-2 hover:text-indigo-600 fill-current">
                        <a href="https://github.com/anthonny">
                            <svg width="28" height="28" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M9.99219 1.49024C5.16211 1.48828 1.25 5.39844 1.25 10.2246C1.25 14.041 3.69727 17.2852 7.10547 18.4766C7.56445 18.5918 7.49414 18.2656 7.49414 18.043V16.5293C4.84375 16.8398 4.73633 15.0859 4.55859 14.793C4.19922 14.1797 3.34961 14.0234 3.60352 13.7305C4.20703 13.4199 4.82227 13.8086 5.53516 14.8613C6.05078 15.625 7.05664 15.4961 7.56641 15.3691C7.67773 14.9102 7.91602 14.5 8.24414 14.1816C5.49805 13.6895 4.35352 12.0137 4.35352 10.0215C4.35352 9.05469 4.67188 8.16602 5.29688 7.44922C4.89844 6.26758 5.33398 5.25586 5.39258 5.10547C6.52734 5.00391 7.70703 5.91797 7.79883 5.99024C8.44336 5.81641 9.17969 5.72461 10.0039 5.72461C10.832 5.72461 11.5703 5.82031 12.2207 5.99609C12.4414 5.82813 13.5352 5.04297 14.5898 5.13867C14.6465 5.28906 15.0723 6.27734 14.6973 7.44336C15.3301 8.16211 15.6523 9.0586 15.6523 10.0273C15.6523 12.0234 14.5 13.7012 11.7461 14.1855C11.982 14.4175 12.1693 14.6942 12.297 14.9993C12.4248 15.3045 12.4905 15.6321 12.4902 15.9629V18.1602C12.5059 18.3359 12.4902 18.5098 12.7832 18.5098C16.2422 17.3438 18.7324 14.0762 18.7324 10.2266C18.7324 5.39844 14.8184 1.49024 9.99219 1.49024V1.49024Z" />
                            </svg>
                        </a>
                    </li>
                    <li class="ml-2 hover:text-indigo-600 fill-current">
                        <a href="https://www.linkedin.com/in/anthonnyquerouil/">
                            <svg width="26" height="26" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M10 0.400024C4.69802 0.400024 0.400024 4.69802 0.400024 10C0.400024 15.302 4.69802 19.6 10 19.6C15.302 19.6 19.6 15.302 19.6 10C19.6 4.69802 15.302 0.400024 10 0.400024ZM7.65002 13.979H5.70602V7.72302H7.65002V13.979ZM6.66602 6.95502C6.05202 6.95502 5.65502 6.52002 5.65502 5.98202C5.65502 5.43302 6.06402 5.01102 6.69102 5.01102C7.31802 5.01102 7.70202 5.43302 7.71402 5.98202C7.71402 6.52002 7.31802 6.95502 6.66602 6.95502ZM14.75 13.979H12.806V10.512C12.806 9.70502 12.524 9.15702 11.821 9.15702C11.284 9.15702 10.965 9.52803 10.824 9.88503C10.772 10.012 10.759 10.192 10.759 10.371V13.978H8.81402V9.71803C8.81402 8.93703 8.78902 8.28402 8.76302 7.72202H10.452L10.541 8.59102H10.58C10.836 8.18302 11.463 7.58102 12.512 7.58102C13.791 7.58102 14.75 8.43802 14.75 10.28V13.979V13.979Z" />
                            </svg>
                        </a>
                    </li>
                </ul>
            </section>
        </header>
        <section class="flex-1 content mt-12">
            <section class="flex-1 px-4 xs:px-12 sm:px-24 md:px-40">
    <section class="post-content">
        <header>
            <section class="flex text-gray-600">
                <section class="published-at">
                    <time datetime="2015-08-31" itemprop="datePublished">
                        5 years ago
                    </time>
                </section>
                <section>
                    <ul class="flex tags">
                        <li><a href="http://anthonnyquerouil.me/tag/Sensit">Sensit</a></li>
                        <li><a href="http://anthonnyquerouil.me/tag/IoT">IoT</a></li>
                        <li><a href="http://anthonnyquerouil.me/tag/Sigfox">Sigfox</a></li>
                        <li><a href="http://anthonnyquerouil.me/tag/Meteor">Meteor</a></li>
                        <li><a href="http://anthonnyquerouil.me/tag/Parrot">Parrot</a></li>
                        <li><a href="http://anthonnyquerouil.me/tag/Rolling Spider">Rolling Spider</a></li>
                    </ul>
                </section>
            </section>
            <h1 class="mt-12 text-2xl sm:text-3xl md:text-4xl text-indigo-800 font-bold">
                Un Sens&#x27;it, Meteor et mon Rolling Spider décolle
            </h1>

        </header>
        <section class="flex-1 content mt-12">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Comme vous l&#8217;avez peut-être lu dans mon précédent billet
<a href="http://anthonnyquerouil.fr/2015/08/24/Sensit-mon-petit-objet-connecte.html" class="bare">http://anthonnyquerouil.fr/2015/08/24/Sensit-mon-petit-objet-connecte.html</a>, j&#8217;ai reçu récemment un <a href="https://www.sensit.io/">Sens&#8217;it</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9440843/9e9e12bc-4a72-11e5-9485-cc94a6735fbf.JPG" alt="9e9e12bc 4a72 11e5 9485 cc94a6735fbf">
</div>
</div>
<div class="paragraph">
<p>J&#8217;ai aussi depuis peu un <a href="http://www.parrot.com/fr/produits/rolling-spider/">Rolling-spider</a> que je m&#8217;étais procuré dans le but de le controller avec un peu de code <a href="https://github.com/ChrisTheBaron/cylon-rolling-spider">JS</a> (c&#8217;est à cause de <a href="http://twitter.com/k33g_org">@k33g_org</a> tout ça). L&#8217;heure est venue de mixer le tout !</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://pbs.twimg.com/media/CNiIQfqWoAAhK9m.jpg" alt="CNiIQfqWoAAhK9m">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_l_objectif">L&#8217;objectif</h2>
<div class="sectionbody">
<div class="paragraph">
<p>L&#8217;objectif est plutôt simple, double cliquer sur le <a href="https://www.sensit.io/">Sens&#8217;it</a> et faire décoller le <a href="http://www.parrot.com/fr/produits/rolling-spider/">Rolling-spider</a>.</p>
</div>
<div class="paragraph">
<p>Pour ce faire, voici ce qu&#8217;il nous faut :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <a href="https://www.sensit.io/">Sens&#8217;it</a>,</p>
</li>
<li>
<p>Un Parrot Rolling Spider,</p>
</li>
<li>
<p>Un framework JS permettant de controller le spider (on utilisera <a href="https://github.com/voodootikigod/node-rolling-spider">node-rolling-spider</a> wrapper dans un package meteor <a href="https://atmospherejs.com/anthonny/rolling-spider">anthonny:rolling-spider</a>),</p>
</li>
<li>
<p>Un peu de Meteor pour lier le tout.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_l_architecture">L&#8217;architecture</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9587833/f979b92c-5024-11e5-9fbf-20a14b2594b8.png" alt="f979b92c 5024 11e5 9fbf 20a14b2594b8">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Le <a href="https://www.sensit.io/">Sens&#8217;it</a> va transmettre un message sur le réseau SIGFOX,</p>
</li>
<li>
<p>Les serveurs SIGFOX vont communiquer aux serveurs AXIBLE qu&#8217;un message <strong>button</strong> a été envoyé,</p>
</li>
<li>
<p>AXIBLE va appelé l&#8217;URL de Callback que nous aurons défini dans l&#8217;interface d&#8217;administration,</p>
</li>
<li>
<p>Ce callback pointera sur une application <strong>sensit.meteor.com</strong> que nous aurons déployée au préalable,</p>
</li>
<li>
<p>Cette dernière enregistrera une trace de l&#8217;appel dans une collection Mongo,</p>
</li>
<li>
<p>Notre application cliente établira une connexion DDP avec l&#8217;application <strong>sensit.meteor.com</strong>, et observera les changements effectués sur cette collection,</p>
</li>
<li>
<p>Au premier changement détecté, on décolle.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_la_remote_app_sensit_meteor_com">La remote-app : sensit.meteor.com</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_définition_de_l_url_de_callback">Définition de l&#8217;URL de callback</h3>
<div class="paragraph">
<p>Dans l&#8217;interface <a href="https://www.sensit.io/">Sens&#8217;it</a>, nous allons spécifier une URL de callback pour les notifications de type <strong>button</strong>.</p>
</div>
<div class="paragraph">
<p>Pour rappel, ce callback est appelé via un GET et peut recevoir en query param certaines valeurs (via des variables {{my_var}}) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>device_id</p>
</li>
<li>
<p>device_serial_number</p>
</li>
<li>
<p>sensor_id</p>
</li>
<li>
<p>mode</p>
</li>
<li>
<p>notification_type</p>
</li>
<li>
<p>data</p>
</li>
<li>
<p>date</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Nous pouvons donc définir l&#8217;URL suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">http://sensit.meteor.com/sensit-callback/button?device_id={{device_id}}&amp;device_serial_number={{device_serial_number}}&amp;sensor_id={{sensor_id}}&amp;mode={{mode}}&amp;notification_type={{notification_type}}&amp;data={{data}}&amp;date={{date}}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9629320/160ef888-5172-11e5-895a-460308bc2a5c.png" alt="160ef888 5172 11e5 895a 460308bc2a5c">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_l_application_meteor">L&#8217;application Meteor</h3>
<div class="paragraph">
<p>Nous créons notre application <strong>meteor</strong> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">meteor create remote-app
cd remote-app
meteor remove autopublish insecure
rm remote-app.*
mkdir server
touch server/main.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour la gestion des routes, on utilisera <a href="http://iron-meteor.github.io/iron-router/">iron-router</a> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">meteor add iron:router</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commençons par créer une collection <code>notification</code> qui aura pour but de stocker les différentes notifications reçues.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Notification = new Meteor.Collection("notification");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il faut ensuite définir notre endpoint qui répondra à l&#8217;appel du callback.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Router.route('/sensit-callback/:type', {where: 'server'})
  .get(function () {
    if (['temperature', 'motion', 'button'].indexOf(this.params.type) &lt; 0)
      throw new Error('Invalid type');

    var notification = _.extend({type: this.params.type}, this.params.query, {data: JSON.parse(this.params.query.data)});

    Notification.insert(notification);
    this.response.end('notification ' + notification.type + ' saved\n');
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous définissons une route <code>/sensit-callback/:type</code> dans laquelle <code>:type</code> peut prendre une des valeurs suivantes <code>['temperature', 'motion', 'button']</code>.</p>
</div>
<div class="paragraph">
<p>On construit ensuite un objet <code>notification</code> à partir du <code>type</code> et des queryParam (on force la conversion en JSON du paramètre <code>data</code> car c&#8217;est un objet JSON stringifié).</p>
</div>
<div class="paragraph">
<p>Enfin on insère notre <code>notification</code> en base et on répond en confirmant l&#8217;enregistrement.</p>
</div>
<div class="paragraph">
<p>Pour que les informations présentes dans notre collection soient accessibles par notre "client", il faut les publier (au passage, on va gérer les autres types) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Meteor.publish("remote-button", function (argument) {
  return Notification.find({type: 'button'});
});
Meteor.publish("remote-temperature", function (argument) {
  return Notification.find({type: 'temperature'});
});
Meteor.publish("remote-motion", function (argument) {
  return Notification.find({type: 'motion'});
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code complet :</p>
</div>
<div class="listingblock">
<div class="title">remote-app/server/main.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">Notification = new Meteor.Collection("notification");

Router.route('/sensit-callback/:type', {where: 'server'})
  .get(function () {
    if (['temperature', 'motion', 'button'].indexOf(this.params.type) &lt; 0)
      throw new Error('Invalid type');

    var notification = _.extend({type: this.params.type}, this.params.query, {data: JSON.parse(this.params.query.data)});

    Notification.insert(notification);
    this.response.end('notification ' + notification.type + ' saved\n');
  });

Meteor.publish("remote-temperature", function (argument) {
  return Notification.find({type: 'temperature'});
});
Meteor.publish("remote-motion", function (argument) {
  return Notification.find({type: 'motion'});
});
Meteor.publish("remote-button", function (argument) {
  return Notification.find({type: 'button'});
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_un_peu_de_test">Un peu de test</h3>
<div class="paragraph">
<p>On démarre l&#8217;application :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">meteor</code></pre>
</div>
</div>
<div class="paragraph">
<p>On requête l&#8217;url :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">http://localhost:3000/sensit-callback/button?device_serial_number=ABCDE&amp;notification_type=generic_punctual&amp;data=%7B%22first_name%22%3A%22Anthonny%22%2C%22sensit_name%22%3A%22%22%2C%22last_name%22%3A%22Querouil%22%2C%22device_id%22%3A%22ABCDE%22%7D&amp;device_id=1234&amp;sensor_id=5678&amp;date=2015-09-01T17%3A37Z&amp;mode=6</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9629955/06bdd084-5177-11e5-8e5b-1aa1478a6413.png" alt="06bdd084 5177 11e5 8e5b 1aa1478a6413">
</div>
</div>
<div class="paragraph">
<p>Le service répond correctement, et notre <code>notification</code> est bien enregistrée :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9630035/b0f0abee-5177-11e5-95dd-1dd622648fce.png" alt="b0f0abee 5177 11e5 95dd 1dd622648fce">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_le_déploiement">Le déploiement</h3>
<div class="paragraph">
<p>L&#8217;application sera déployée sur l&#8217;URL <strong>sensit.meteor.com</strong> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">meteor deploy sensit.meteor.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pour valider le bon déploiement, on peut reprendre le test effectué au préalable et le faire pointer sur notre "production" :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">http://sensit.meteor.com/sensit-callback/button?device_serial_number=ABCDE&amp;notification_type=generic_punctual&amp;data=%7B%22first_name%22%3A%22Anthonny%22%2C%22sensit_name%22%3A%22%22%2C%22last_name%22%3A%22Querouil%22%2C%22device_id%22%3A%22ABCDE%22%7D&amp;device_id=1234&amp;sensor_id=5678&amp;date=2015-09-01T17%3A37Z&amp;mode=6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enfin, on vérifie que la <code>notification</code> est bien présente en base :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://cloud.githubusercontent.com/assets/2006548/9630272/66e493a6-5179-11e5-9230-36ecf85d83e1.png" alt="66e493a6 5179 11e5 9230 36ecf85d83e1">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_la_local_app_sensit_meteor_rs">La local-app : sensit-meteor-rs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons désormais un <strong>backend</strong> qui prend en compte les différentes notifications, il nous faut maintenant une application qui tournera <strong>localement</strong> et qui réagira aux changements qui surviennent dans le backend.</p>
</div>
<div class="sect2">
<h3 id="_l_application">L&#8217;application</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">meteor create local-app
cd local-app
meteor remove autopublish insecure
rm local-app.*
mkdir server
touch server/main.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous allons initier une connexion <a href="https://www.meteor.com/ddp">DDP</a> avec notre <strong>backend</strong> et écouter les changements qui sont faits sur la collection <code>notification</code>.
Pour chaque notification ajoutée dans cette collection que nous appellerons <code>RemoteNotification</code>, nous ajouterons une copie dans notre collection <strong>locale</strong> <code>Notification</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// Déclaration de la connexion
var remote = DDP.connect('http://sensit.meteor.com/');
var RemoteNotification = new Meteor.Collection('notification', { connection: remote });
remote.subscribe('remote-button');

// On écoute les changements effectués sur la collection en Remote
RemoteNotification.find().observe({
  added: function(notification) {
    console.log('-- remote item added --');
    // On upsert dans la collection de Notification locale
    Notification.upsert({notification._id}, {$set: notification});
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il ne nous reste plus qu&#8217;à faire décoller le spider lorsqu&#8217;une <code>notification</code> est ajoutée en local :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var rollingSpider = new RollingSpider();

rollingSpider.connect(Meteor.bindEnvironment(function () {
  rollingSpider.setup(Meteor.bindEnvironment(function () {
    rollingSpider.flatTrim();
    rollingSpider.startPing();
    rollingSpider.flatTrim();

    // On observe la collection Notification, au premier ajout on decolle !
    Notification.find().observe({
      added: function (notification) {
        rollingSpider.takeOff();
        rollingSpider.flatTrim();
      }
    });
  }));
}));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code complet :</p>
</div>
<div class="listingblock">
<div class="title">local-app/server/main.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var Notification = new Meteor.Collection("notification");
var remote = DDP.connect('http://sensit.meteor.com/');
var RemoteNotification = new Meteor.Collection('notification', { connection: remote });
var isFlying = false;


RemoteNotification.find().observe({
  added: function(notification) {
    console.log('-- remote item --');
    console.log(notification);
    Notification.upsert({_id: notification._id}, {$set: notification});
  }
});
remote.subscribe('remote-button');

rollingSpider.connect(Meteor.bindEnvironment(function () {
  rollingSpider.setup(Meteor.bindEnvironment(function () {
    rollingSpider.flatTrim();
    rollingSpider.startPing();
    rollingSpider.flatTrim();

    Notification.find().observe({
      added: function (notification) {
        if (!isFlying) {
          isFlying = true;
          rollingSpider.takeOff();
          rollingSpider.flatTrim();
        }
      }
    });
  }));
}));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_décollage">Décollage !</h3>
<div class="videoblock">
<div class="content">
<iframe src="https://www.youtube.com/embed/8DY4bsKOm5g?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce billet est l&#8217;occasion de mettre en avant la connexion entre deux applications <a href="https://www.meteor.com">Meteor</a> via le protocole <a href="https://www.meteor.com/ddp">DDP</a> et de vous montrer qu&#8217;avec du javascript, on se marre bien (en tout cas, c&#8217;est vrai pour moi :) ).</p>
</div>
<div class="paragraph">
<p>Si vous avez des projets similaires, n&#8217;hésitez pas à m&#8217;en faire part, ce sera un plaisir d&#8217;échanger dessus.</p>
</div>
</div>
</div>
        </section>
    </section>
</section>
        </section>
        <footer class="mt-8 py-4 flex flex-col justify-center items-center text-xs text-indigo-800">
            <section>© 2020. All Rights Reserved.</section>
            <section>
                Proudly published with
                <a href="#" class="hover:text-indigo:600 underline">HubPress</a>
            </section>
        </footer>

    </main>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>

    <script src="//anthonnyquerouil.me/themes/indigo-theme/assets/main.72b48d87.js?v=1592555481261"></script>



    <!-- Fathom - beautiful, simple website analytics -->
    <script src="https://cdn.usefathom.com/script.js" site="RMDAJFGG"></script>
    <!-- / Fathom -->
</body>

</html>